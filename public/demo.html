const express = require('express');
const fetch = require('node-fetch'); // para Node < 18
const app = express();
const PORT = process.env.PORT || 3000;

// 1) Servir arquivos estáticos da pasta "public"
app.use(express.static('public'));

/**
 *  2) /api/start-n8n
 *     - Chama o webhook "Start Job" no n8n (que usa "Respond to Webhook" para retornar { jobId, ... } imediatamente).
 *     - Devolve esse JSON ao front-end.
 */
app.get('/api/start-n8n', async (req, res) => {
  try {
    // URL de produção do seu Start Job Webhook (GET)
    const startEndpoint = 'https://makeone.app.n8n.cloud/webhook/webhook/start-job';

    // Faz a chamada ao n8n
    const response = await fetch(startEndpoint, { method: 'GET' });
    if (!response.ok) {
      throw new Error(`Erro ao iniciar job no n8n: ${response.statusText}`);
    }

    // Esperamos algo como { jobId: "...", userFacingMessage: "..." }
    const data = await response.json();
    // repassamos ao front-end
    res.json(data);

  } catch (err) {
    console.error('Erro ao iniciar job no n8n:', err);
    res.status(500).json({ error: 'Ocorreu um erro ao iniciar o job no n8n.' });
  }
});

/**
 *  3) /api/status-n8n?jobId=XYZ
 *     - O front-end fará polling a cada X segundos para ver se o job terminou.
 *     - Chamamos o webhook de "Check Status" no n8n com o mesmo jobId.
 *       Se pronto, retorna { done: true, headlines: [...], artigos: [...] }.
 *       Se ainda em processamento, retorna { done: false }.
 */
app.get('/api/status-n8n', async (req, res) => {
  try {
    const { jobId } = req.query;
    if (!jobId) {
      return res.status(400).json({ error: 'Faltou jobId.' });
    }

    // URL de produção do Check Status Webhook (GET)
    const statusEndpoint = `https://makeone.app.n8n.cloud/webhook/webhook/check-status?jobId=${jobId}`;

    const response = await fetch(statusEndpoint, { method: 'GET' });
    if (!response.ok) {
      throw new Error(`Erro ao checar status no n8n: ${response.statusText}`);
    }

    // Esperamos { done: false } ou { done: true, headlines: [...], artigos: [...] }
    const data = await response.json();
    res.json(data);

  } catch (err) {
    console.error('Erro ao checar status n8n:', err);
    res.status(500).json({ error: 'Ocorreu um erro ao checar status no n8n.' });
  }
});

// 4) Iniciar o servidor
app.listen(PORT, () => {
  console.log(`Servidor rodando na porta ${PORT}...`);
});
